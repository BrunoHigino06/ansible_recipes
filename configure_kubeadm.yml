# configure_kubeadm.yml
---
- name: Configure kubeadm
  hosts: all
  become: yes
  tasks:
    - block: 
        - name: Disable swap
          command: swapoff -a
        
        - name: Initialize Kubernetes master
          command: kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=all
          register: kubeadm_output
          ignore_errors: yes
        
        - debug: var=kubeadm_output.stdout_lines
        
        - name: Set up kubectl for the current user
          command: "{{ item }}"
          with_items:
            - "mkdir -p $HOME/.kube"
            - "cp /etc/kubernetes/admin.conf $HOME/.kube/config"  
        
        - name: Change kubeconfig file permission
          file:
            path: $HOME/.kube/config 
            owner: ubuntu

        - name: Install Calico network plugin
          command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
          when: kubeadm_output is kubeadm_output.ok or kubeadm_output.changed